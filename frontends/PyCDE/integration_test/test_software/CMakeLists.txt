cmake_minimum_required(VERSION 3.20)
project(esi_cpp_test LANGUAGES CXX)

set(CMAKE_CXX_STANDARD 20)
set(CMAKE_CXX_STANDARD_REQUIRED ON)

# Generated headers from esiaccel.codegen live under this directory.
set(LOOPBACK_GENERATED_DIR "" CACHE PATH "Generated header directory")
if (NOT LOOPBACK_GENERATED_DIR)
  message(FATAL_ERROR "LOOPBACK_GENERATED_DIR must be set")
endif()

# Optional hint roots to help locate the ESI runtime headers and libraries.
set(ESI_RUNTIME_ROOT "$ENV{ESI_RUNTIME_ROOT}" CACHE PATH
  "ESI runtime build/install root")
if (NOT ESI_RUNTIME_ROOT)
  message(FATAL_ERROR "ESI_RUNTIME_ROOT must be set or available in the environment")
endif()

set(ESIACCEL_CONFIG "${ESI_RUNTIME_ROOT}/cpp/cmake/esiaccelConfig.cmake")
if (EXISTS "${ESIACCEL_CONFIG}")
  include("${ESIACCEL_CONFIG}")
  set(ESI_RUNTIME_TARGET esiaccel::ESICppRuntime)
  get_target_property(_esi_runtime_includes
    "${ESI_RUNTIME_TARGET}" INTERFACE_INCLUDE_DIRECTORIES)
  if (_esi_runtime_includes)
    list(GET _esi_runtime_includes 0 _esi_runtime_include_probe)
    if (NOT EXISTS "${_esi_runtime_include_probe}")
      unset(ESI_RUNTIME_TARGET)
    endif()
  endif()
endif()

if (NOT ESI_RUNTIME_TARGET)
  find_path(ESI_RUNTIME_INCLUDE_DIR
    NAMES esi/Accelerator.h
    PATHS "${ESI_RUNTIME_ROOT}"
    PATH_SUFFIXES cpp/include cpp/cmake/../include)
  if (NOT ESI_RUNTIME_INCLUDE_DIR)
    set(_runtime_cursor "${ESI_RUNTIME_ROOT}")
    foreach(_idx RANGE 1 8)
      get_filename_component(_runtime_cursor "${_runtime_cursor}" DIRECTORY)
      if (_runtime_cursor STREQUAL "")
        break()
      endif()
      if (EXISTS "${_runtime_cursor}/lib/Dialect/ESI/runtime/cpp/include/esi/Accelerator.h")
        set(ESI_RUNTIME_INCLUDE_DIR
            "${_runtime_cursor}/lib/Dialect/ESI/runtime/cpp/include")
        break()
      endif()
    endforeach()
  endif()

  find_library(ESI_RUNTIME_LIB
    NAMES ESICppRuntime
    PATHS "${ESI_RUNTIME_ROOT}"
    PATH_SUFFIXES lib lib64 cpp/lib)
  if (NOT ESI_RUNTIME_LIB)
    set(_runtime_build_root "${ESI_RUNTIME_ROOT}")
    foreach(_idx RANGE 1 6)
      get_filename_component(_runtime_build_root "${_runtime_build_root}" DIRECTORY)
    endforeach()
    if (EXISTS "${_runtime_build_root}/lib/libESICppRuntime.so")
      set(ESI_RUNTIME_LIB "${_runtime_build_root}/lib/libESICppRuntime.so")
    elseif (EXISTS "${_runtime_build_root}/lib/libESICppRuntime.dylib")
      set(ESI_RUNTIME_LIB "${_runtime_build_root}/lib/libESICppRuntime.dylib")
    elseif (EXISTS "${_runtime_build_root}/lib64/libESICppRuntime.so")
      set(ESI_RUNTIME_LIB "${_runtime_build_root}/lib64/libESICppRuntime.so")
    endif()
  endif()
  if (NOT ESI_RUNTIME_LIB)
    if (EXISTS "${ESI_RUNTIME_ROOT}/cpp/lib/libESICppRuntime.so")
      set(ESI_RUNTIME_LIB "${ESI_RUNTIME_ROOT}/cpp/lib/libESICppRuntime.so")
    elseif (EXISTS "${ESI_RUNTIME_ROOT}/cpp/lib/libESICppRuntime.dylib")
      set(ESI_RUNTIME_LIB "${ESI_RUNTIME_ROOT}/cpp/lib/libESICppRuntime.dylib")
    elseif (EXISTS "${ESI_RUNTIME_ROOT}/cpp/ESICppRuntime.dll")
      set(ESI_RUNTIME_LIB "${ESI_RUNTIME_ROOT}/cpp/ESICppRuntime.dll")
    endif()
  endif()
endif()

find_path(CLI11_INCLUDE_DIR
  NAMES CLI/CLI.hpp
  PATHS "${ESI_RUNTIME_ROOT}"
  PATH_SUFFIXES _deps/cli11_proj-src/include)

if (NOT CLI11_INCLUDE_DIR)
  set(_cli11_cursor "${ESI_RUNTIME_ROOT}")
  foreach(_idx RANGE 1 8)
    get_filename_component(_cli11_cursor "${_cli11_cursor}" DIRECTORY)
    if (_cli11_cursor STREQUAL "")
      break()
    endif()
    if (EXISTS "${_cli11_cursor}/_deps/cli11_proj-src/include/CLI/CLI.hpp")
      set(CLI11_INCLUDE_DIR
          "${_cli11_cursor}/_deps/cli11_proj-src/include")
      break()
    endif()
  endforeach()
endif()

if (NOT ESI_RUNTIME_TARGET)
  if (NOT ESI_RUNTIME_INCLUDE_DIR)
    message(FATAL_ERROR "ESI runtime headers not found (esi/Accelerator.h)")
  endif()
  if (NOT ESI_RUNTIME_LIB)
    message(FATAL_ERROR "ESICppRuntime library not found")
  endif()
endif()
if (NOT CLI11_INCLUDE_DIR)
  message(FATAL_ERROR "CLI11 headers not found (CLI/CLI.hpp)")
endif()

# This target depends on headers generated by the test; it is not expected to
# compile without running esiaccel.codegen first.
if (NOT EXISTS "${LOOPBACK_GENERATED_DIR}/loopback/LoopbackIP.h")
  message(STATUS "loopback_test expects generated headers under ${LOOPBACK_GENERATED_DIR}")
endif()
add_executable(loopback_test
  "${CMAKE_CURRENT_SOURCE_DIR}/loopback.cpp")
set_target_properties(loopback_test PROPERTIES
  RUNTIME_OUTPUT_DIRECTORY "${CMAKE_BINARY_DIR}")

target_include_directories(loopback_test PRIVATE
  "${LOOPBACK_GENERATED_DIR}"
  "${CLI11_INCLUDE_DIR}")

if (ESI_RUNTIME_TARGET)
  target_link_libraries(loopback_test PRIVATE
    "${ESI_RUNTIME_TARGET}")
  get_target_property(_esi_runtime_lib_path
    "${ESI_RUNTIME_TARGET}" IMPORTED_LOCATION)
  if (_esi_runtime_lib_path)
    get_filename_component(_esi_runtime_lib_dir
      "${_esi_runtime_lib_path}" DIRECTORY)
  endif()
else()
  target_include_directories(loopback_test PRIVATE
    "${ESI_RUNTIME_INCLUDE_DIR}")
  target_link_libraries(loopback_test PRIVATE
    "${ESI_RUNTIME_LIB}")
  get_filename_component(_esi_runtime_lib_dir "${ESI_RUNTIME_LIB}" DIRECTORY)
endif()

if (UNIX AND _esi_runtime_lib_dir)
  set_target_properties(loopback_test PROPERTIES
    BUILD_RPATH "${_esi_runtime_lib_dir}")
endif()
