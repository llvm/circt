// NOTE: Assertions have been autogenerated by utils/update_mlir_test_checks.py
// RUN: circt-opt -canonicalize='top-down=true region-simplify=true' %s | FileCheck %s
module {

  // CHECK-LABEL: handshake.func @simple(
  // CHECK-SAME:                         %[[VAL_0:.*]]: none, ...) -> none attributes {argNames = ["arg0"], resNames = ["outCtrl"]} {
  handshake.func @simple(%arg0: none, ...) -> none {
    %c:2 = "handshake.fork"(%arg0) {control = true} : (none) -> (none, none)

    // CHECK: %[[VAL_1:.*]] = "handshake.constant"(%[[VAL_0:.*]]) {value = 1 : index} : (none) -> index
    %0 = "handshake.constant"(%c#0) {value = 1 : index} : (none) -> index

    // CHECK-NOT: %[[TMP_0:.*]] = "handshake.branch"(%[[VAL_0:.*]]) {control = true} : (none) -> none
    // CHECK-NOT: %[[TMP_1:.*]] = "handshake.branch"(%[[VAL_1:.*]]) {control = false} : (index) -> index
    %1 = "handshake.branch"(%c#1) {control = true} : (none) -> none
    %2 = "handshake.branch"(%0) {control = false} : (index) -> index

    // CHECK-NOT: %[[TMP_2:.*]] = "handshake.merge"(%[[TMP_0:.*]]) : (none) -> none
    // CHECK-NOT: %[[TMP_3:.*]] = "handshake.merge"(%[[TMP_1:.*]]) : (index) -> index
    %3 = "handshake.merge"(%1) : (none) -> none
    %4 = "handshake.merge"(%2) : (index) -> index

    // CHECK-NEXT: %[[VAL_2:.*]]:2 = "handshake.fork"(%[[VAL_0:.*]]) {control = true} : (none) -> (none, none)
    %5:2 = "handshake.fork"(%3) {control = true} : (none) -> (none, none)
    %6 = "handshake.constant"(%5#0) {value = 42 : index} : (none) -> index
    %7 = arith.addi %4, %6 : index
    "handshake.sink"(%7) : (index) -> ()
    handshake.return %5#1 : none
  }

  // CHECK-LABEL: cmerge_with_control_used
  handshake.func @cmerge_with_control_used(%arg0: none, %arg1: none, %arg2: none) -> (none, index, none) {
    // CHECK: "handshake.control_merge"(%{{.+}}, %{{.+}})
    // CHECK: handshake.return
    %result, %index = "handshake.control_merge"(%arg0, %arg1) {control = true} : (none, none) -> (none, index)
    handshake.return %result, %index, %arg2 : none, index, none
  }

  // CHECK-LABEL: cmerge_with_control_sunk
  handshake.func @cmerge_with_control_sunk(%arg0: none, %arg1: none, %arg2: none) -> (none, none) {
    // CHECK: "handshake.merge"(%{{.+}}, %{{.+}})
    // CHECK-NOT: "handshake.control_merge"
    // CHECK-NOT: "handshake.sink"
    %result, %index = "handshake.control_merge"(%arg0, %arg1) {control = true} : (none, none) -> (none, index)
    "handshake.sink"(%index) : (index) -> ()
    handshake.return %result, %arg2 : none, none
  }

  // CHECK-LABEL: sunk_constant
  handshake.func @sunk_constant(%arg0: none) -> (none) {
    // CHECK-NOT: handshake.fork
    // CHECK-NOT: handshake.constant
    // CHECK-NOT: handshake.sink
    %c:2 = "handshake.fork"(%arg0) {control = true} : (none) -> (none, none)
    %0 = "handshake.constant"(%c#0) { value = 24 : i8 } : (none) -> i8
    "handshake.sink"(%0) : (i8) -> ()
    handshake.return %c#1: none
  }
}
