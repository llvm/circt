//===----------------------------------------------------------------------===//
//
// Part of the LLVM Project, under the Apache License v2.0 with LLVM Exceptions.
// See https://llvm.org/LICENSE.txt for license information.
// SPDX-License-Identifier: Apache-2.0 WITH LLVM-exception
//
//===----------------------------------------------------------------------===//
//
// This file implements datapath ops.
//
//===----------------------------------------------------------------------===//

#include "circt/Dialect/Datapath/DatapathOps.h"

using namespace circt;
using namespace datapath;

LogicalResult CompressOp::verify() {
  // The compressor must reduce the number of operands by at least 1 otherwise
  // it fails to perform any reduction.
  if (getNumOperands() < 3)
    return emitOpError("requires 3 or more arguments - otherwise use add");

  if (getNumResults() >= getNumOperands())
    return emitOpError("must reduce the number of operands by at least 1");

  if (getNumResults() < 2)
    return emitOpError("must produce at least 2 results");

  return success();
}

// Parser for the custom type format
// Parser for "<num-inputs> x <input-type> -> <output-type>"
static ParseResult parseCompressFormat(OpAsmParser &parser,
                                       SmallVectorImpl<Type> &inputTypes) {

  int64_t inputCount;
  Type inputElementType;

  if (parser.parseInteger(inputCount) || parser.parseKeyword("x") ||
      parser.parseType(inputElementType))
    return failure();

  // Parse arrow
  if (parser.parseArrow())
    return failure();

  // Parse output types
  if (parser.parseLParen())
    return failure();

  if (parser.parseRParen())
    return failure();

  // Fill input types
  inputTypes.assign(inputCount, inputElementType);

  return success();
}

// Printer for "<num-inputs> x <input-type> -> <output-type>"
static void printCompressFormat(OpAsmPrinter &printer, Operation *op,
                                TypeRange inputTypes) {

  // Print input types as "count x type"
  printer << inputTypes.size() << " x " << inputTypes[0];

  printer << " -> ";
}

//===----------------------------------------------------------------------===//
// TableGen generated logic.
//===----------------------------------------------------------------------===//

// Provide the autogenerated implementation guts for the Op classes.
#define GET_OP_CLASSES
#include "circt/Dialect/Datapath/Datapath.cpp.inc"
