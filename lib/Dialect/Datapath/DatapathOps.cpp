//===- DatapathOps.cpp - Implement the Datapath operations ------------------------===//
//
// Part of the LLVM Project, under the Apache License v2.0 with LLVM Exceptions.
// See https://llvm.org/LICENSE.txt for license information.
// SPDX-License-Identifier: Apache-2.0 WITH LLVM-exception
//
//===----------------------------------------------------------------------===//
//
// This file implements datapath ops.
//
//===----------------------------------------------------------------------===//

#include "circt/Dialect/Datapath/DatapathOps.h"

using namespace circt;
using namespace datapath;

//===----------------------------------------------------------------------===//
// Unary Operations
//===----------------------------------------------------------------------===//

LogicalResult CompressOp::verify() {
  // The compressor must reduce the number of operands by at least 1 otherwise 
  // it fails to perform any reduction.
  if (getNumOperands() < 3)
    return emitOpError("Requires 3 or more arguments - otherwise use add");

  if (getNumResults() >= getNumOperands())
    return emitOpError("Must reduce the number of operands by at least 1");

  if (getNumResults() < 2)
    return emitOpError("Must produce at least 2 results");
  
  return success();
}

ParseResult CompressOp::parse(OpAsmParser &parser, OperationState &result) {
  SmallVector<OpAsmParser::UnresolvedOperand, 8> operands;
  
  // Parse the operands
  if (parser.parseOperandList(operands))
    return failure();
  
  // Parse the colon
  if (parser.parseColon())
    return failure();
  
  // Parse the number literal
  size_t numOperands;
  if (parser.parseInteger(numOperands))
    return failure();  
  
  // Parse the "x" token
  if (parser.parseKeyword("x"))
    return failure();  
  
    // Parse the operand type
  Type operandType;
  if (parser.parseType(operandType))
    return failure();
  
    
  // Verify the number of operands
  if (numOperands != operands.size()) {
    return parser.emitError(parser.getNameLoc(), 
      "number of operands does not match specified count");
  }
  
  // Parse the arrow and result type list
  SmallVector<Type, 2> resultTypes;
  if (parser.parseArrow() || 
      parser.parseLParen() ||
      parser.parseTypeList(resultTypes) ||
      parser.parseRParen())
    return failure();
  
  // Resolve the operands
  SmallVector<Type> operandTypes(operands.size(), operandType);
  if (parser.resolveOperands(operands, operandTypes, parser.getNameLoc(), result.operands))
    return failure();
    
  // Set the result types
  result.addTypes(resultTypes);
  
  return success();
}

// Custom printer for the CompressOp
void CompressOp::print(OpAsmPrinter &p) {
  // Print the operation name and operands
  p << " " << getOperands();
  
  // Get the first operand type
  Type operandType = getOperand(0).getType();
  
  // Print the custom format with number of operands
  p << " : " << getNumOperands() << " x " << operandType << " -> (";
  // p << " : " << operandType << ":" << getNumOperands() << " -> (";
  
  // Print result types
  llvm::interleaveComma(getResultTypes(), p);
  
  p << ")";
}

//===----------------------------------------------------------------------===//
// TableGen generated logic.
//===----------------------------------------------------------------------===//

// Provide the autogenerated implementation guts for the Op classes.
#define GET_OP_CLASSES
#include "circt/Dialect/Datapath/Datapath.cpp.inc"
